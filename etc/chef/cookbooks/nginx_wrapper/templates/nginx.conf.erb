user <%= @nginx_user %><% if @nginx_user != @group %> <%= @group %><% end %>;
worker_processes <%= @worker_processes %>;
error_log <%= @nginx_log_dir %>/error.log;
pid <%= @pid %>;

<% if (node['platform'] == 'debian' && node['platform_version'].to_i >= 9) || (node['platform'] == 'ubuntu' && node['platform_version'].to_i >= 18) %>
include /etc/nginx/modules-enabled/*.conf;
<% end -%>
<% if %w(amazon centos fedora).include?(node['platform']) -%>
include /usr/share/nginx/modules/*.conf;
<% end -%>

events {
  worker_connections <%= @worker_connections %>;
}

http {
  map $time_iso8601 $year {
    default '0000';
    "~^(\d{4})-(\d{2})-(\d{2})" $1;
  }
  map $time_iso8601 $month {
      default '00';
      "~^(\d{4})-(\d{2})-(\d{2})" $2;
  }
  map $time_iso8601 $day {
      default '00';
      "~^(\d{4})-(\d{2})-(\d{2})" $3;
  }
  log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';

  access_log  <%= @nginx_log_dir %>/access.log main;

  sendfile            <%= @sendfile %>;
  tcp_nopush          <%= @tcp_nopush %>;
  tcp_nodelay         <%= @tcp_nodelay %>;
  keepalive_timeout   <%= @keepalive_timeout %>;
  types_hash_max_size <%= @types_hash_max_size %>;

  include       <%= @nginx_dir %>/mime.types;
  default_type  application/octet-stream;

  include <%= @nginx_dir %>/conf.d/*.conf;
  include <%= @nginx_dir %>/sites-enabled/*;
}


